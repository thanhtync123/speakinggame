<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Nghe & Nói Tiếng Anh</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #6a11cb, #2575fc);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .description {
            text-align: center;
            margin-bottom: 30px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .topic-selector {
            margin-bottom: 25px;
            text-align: center;
        }
        
        .topic-selector select {
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-size: 16px;
            width: 100%;
            max-width: 300px;
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .topic-selector select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .question-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .question-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .question {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .answer {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: none;
            border-left: 4px solid #2ecc71;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
        }
        
        .show-answer-btn {
            background-color: #3498db;
            color: white;
            flex: 1;
            min-width: 140px;
        }
        
        .show-answer-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .speak-btn {
            background-color: #9b59b6;
            color: white;
            flex: 1;
            min-width: 140px;
        }
        
        .speak-btn:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }
        
        .record-btn {
            background-color: #e74c3c;
            color: white;
            flex: 1;
            min-width: 140px;
        }
        
        .record-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .record-btn.recording {
            background-color: #c0392b;
            animation: pulse 1.5s infinite;
        }
        
        .speak-btn.playing {
            background-color: #8e44ad;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .hidden {
            display: none;
        }
        
        .topic-title {
            text-align: center;
            margin: 20px 0;
            color: #3498db;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #e74c3c;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .recording-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ddd;
        }
        
        .recording-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .recording-timer {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }
        
        .evaluation-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .evaluation-result.pass {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 2px solid #2ecc71;
        }
        
        .evaluation-result.fail {
            background-color: #fadbd8;
            color: #c0392b;
            border: 2px solid #e74c3c;
        }
        
        .audio-playback {
            margin-top: 15px;
            text-align: center;
        }
        
        .audio-playback audio {
            width: 100%;
            max-width: 400px;
        }
        
        .voice-selector {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .voice-selector select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 100%;
            max-width: 250px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .recording-controls {
                flex-direction: column;
            }
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .no-questions {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Luyện Nghe & Nói Tiếng Anh</h1>
        <p class="description">Nghe câu hỏi, ghi âm câu trả lời và nhận đánh giá tự động!</p>
        
        <div class="topic-selector">
            <select id="topicSelect">
                <option value="all">Tất cả chủ đề</option>
                <option value="greeting">Chào hỏi</option>
                <option value="hobby">Sở thích</option>
                <option value="transport">Giao thông</option>
                <option value="travel">Du lịch</option>
                <option value="free-time">Thời gian rảnh</option>
                <option value="school">Trường học</option>
                <option value="family">Gia đình</option>
            </select>
        </div>
        
        <div class="voice-selector">
            <select id="voiceSelect">
                <option value="">Chọn giọng đọc...</option>
            </select>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalQuestions">0</div>
                <div class="stat-label">Tổng số câu</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="viewedAnswers">0</div>
                <div class="stat-label">Đã xem</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="listenedQuestions">0</div>
                <div class="stat-label">Đã nghe</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Đã đạt</div>
            </div>
        </div>
        
        <div id="questionsContainer">
            <!-- Các câu hỏi sẽ được thêm vào đây bằng JavaScript -->
        </div>
        
        <div class="footer">
            Ứng dụng luyện nghe & nói tiếng Anh - Web Speech API & MediaRecorder API
        </div>
    </div>

    <div class="notification" id="notification">
        Trình duyệt của bạn không hỗ trợ chức năng đọc văn bản. Vui lòng sử dụng Chrome, Edge hoặc Safari.
    </div>

    <script>
        // Dữ liệu câu hỏi và câu trả lời ĐẦY ĐỦ
        const questionsData = [
            // GREETING - CHÀO HỎI
            {
                topic: "greeting",
                question: "What's your full name?",
                answer: "My full name is Nguyen Thi Phuong Mai",
                keywords: ["name", "full name", "Nguyen", "Phuong Mai"]
            },
            {
                topic: "greeting",
                question: "What's your student number?",
                answer: "My student number is 21010072",
                keywords: ["student", "number", "21010072"]
            },
            {
                topic: "greeting",
                question: "How old are you?",
                answer: "I am 21 years old",
                keywords: ["old", "age", "21", "years"]
            },
            {
                topic: "greeting",
                question: "Where's your hometown?",
                answer: "My hometown is Dong Thap province",
                keywords: ["hometown", "Dong Thap", "province"]
            },
            {
                topic: "greeting",
                question: "What do you like doing in your free time?",
                answer: "In my free time, I like watching TV and listening to music",
                keywords: ["free time", "watching", "TV", "listening", "music"]
            },
            {
                topic: "greeting",
                question: "How do you travel to school?",
                answer: "I travel to school by motorbike",
                keywords: ["travel", "school", "motorbike", "by"]
            },
            {
                topic: "greeting",
                question: "What's your major?",
                answer: "My major is Vet",
                keywords: ["major", "vet", "veterinary"]
            },
            {
                topic: "greeting",
                question: "What would you like to do in the future?",
                answer: "In the future I would like to be a skilled veterinarian so I can help animals and improve their health.",
                keywords: ["future", "veterinarian", "help", "animals", "health"]
            },

            // HOBBY - SỞ THÍCH
            {
                topic: "hobby",
                question: "Do you have any hobbies? What are they?",
                answer: "Yes I do, I like watching TV and listening to music",
                keywords: ["hobbies", "watching", "TV", "listening", "music"]
            },
            {
                topic: "hobby",
                question: "Do you have enough time for your hobby? Why (not)?",
                answer: "Yes of course. I spend about 30 minutes listening to music every day because it helps me relax and feel happy after school",
                keywords: ["enough time", "30 minutes", "every day", "relax", "happy"]
            },
            {
                topic: "hobby",
                question: "Do you spend lots of money on your hobbies? Why (not)?",
                answer: "No, I don't. Because I often watch movies and listen to music online",
                keywords: ["money", "online", "watch movies", "listen to music"]
            },
            {
                topic: "hobby",
                question: "How long have you had your hobby?",
                answer: "I have had my hobby for ten years.",
                keywords: ["how long", "ten years", "have had"]
            },
            {
                topic: "hobby",
                question: "What hobby would you like to try in the future?",
                answer: "In the future, I would like to try volleyball",
                keywords: ["future", "try", "volleyball"]
            },
            {
                topic: "hobby",
                question: "What are some popular hobbies (for men and women) in your country?",
                answer: "I think there are some popular hobbies (for men and women) in my country. There are listening to music, playing sport and watching TV",
                keywords: ["popular hobbies", "men", "women", "country", "listening to music", "playing sport", "watching TV"]
            },

            // TRANSPORT - GIAO THÔNG
            {
                topic: "transport",
                question: "How do you travel to school or work?",
                answer: "I usually often go to school by motorbike",
                keywords: ["travel", "school", "work", "motorbike"]
            },
            {
                topic: "transport",
                question: "Do you prefer public transportation or private transportation? Why?",
                answer: "I prefer private transportation. Because it is comfortable, convenient and fast",
                keywords: ["prefer", "private transportation", "comfortable", "convenient", "fast"]
            },
            {
                topic: "transport",
                question: "What types of public transport are popular in your hometown?",
                answer: "They are buses and taxis",
                keywords: ["public transport", "popular", "hometown", "buses", "taxis"]
            },
            {
                topic: "transport",
                question: "Do you think public transport should be free? Why (not)?",
                answer: "Yes, of course. Because if it were free, many people would use public transport. This is good for the environment.",
                keywords: ["public transport", "free", "many people", "environment"]
            },
            {
                topic: "transport",
                question: "How often do you use public transport (such as bus or taxi)?",
                answer: "I never/sometimes use public transport",
                keywords: ["how often", "public transport", "bus", "taxi", "never", "sometimes"]
            },
            {
                topic: "transport",
                question: "Are there any transport problems in your hometown? What are they?",
                answer: "Yes, there are. The main problems are traffic jams during rush hours and traffic accidents.",
                keywords: ["transport problems", "hometown", "traffic jams", "rush hours", "traffic accidents"]
            },

            // TRAVEL - DU LỊCH
            {
                topic: "travel",
                question: "Do you like traveling? Why?",
                answer: "Yes, I do. Studying is stressful and can drain my energy, so traveling helps me relax and clear my mind after stressful days",
                keywords: ["like traveling", "stressful", "energy", "relax", "clear mind"]
            },
            {
                topic: "travel",
                question: "Do you like to travel alone or in a group? Why?",
                answer: "I like traveling in a group. Because we can do many things together such as eating, playing, taking pictures together.",
                keywords: ["travel alone", "group", "together", "eating", "playing", "taking pictures"]
            },
            {
                topic: "travel",
                question: "In which season do you prefer to travel?",
                answer: "I prefer to travel season in spring. Because it is many flowers and the weather is nice",
                keywords: ["season", "prefer", "spring", "flowers", "weather", "nice"]
            },
            {
                topic: "travel",
                question: "What places have you visited up to now?",
                answer: "I have visited Vung Tau and Da Lat",
                keywords: ["places", "visited", "Vung Tau", "Da Lat"]
            },
            {
                topic: "travel",
                question: "What do you like to do when you visit new places?",
                answer: "When I visit new places, I like taking pictures, eating delicious food, and meeting new people",
                keywords: ["new places", "taking pictures", "eating", "delicious food", "meeting new people"]
            },
            {
                topic: "travel",
                question: "Do you think your hometown is a good place for a holiday? Why?",
                answer: "Yes I think. My hometown is in Sa Dec city. It's a great place for a holiday. Because it's peaceful, with beautiful flower gardens, rivers, and delicious local food.",
                keywords: ["hometown", "good place", "holiday", "Sa Dec", "peaceful", "flower gardens", "rivers", "local food"]
            },

            // FREE TIME - THỜI GIAN RẢNH
            {
                topic: "free-time",
                question: "What do you usually do after school?",
                answer: "I usually go to coffee shops with my friend after school and listen to music",
                keywords: ["usually", "after school", "coffee shops", "friend", "listen to music"]
            },
            {
                topic: "free-time",
                question: "How do you spend your weekends/weekdays?",
                answer: "I spend most day of the week from Monday to Friday studying. On weekends I spend relaxing and play sports",
                keywords: ["spend", "weekends", "weekdays", "studying", "relaxing", "play sports"]
            },
            {
                topic: "free-time",
                question: "Do you like listening to music/ reading books/ watching TV/ playing games? Why?",
                answer: "I like reading books because it gives me a lot of knowledge in many different fields and improve my communication skills",
                keywords: ["reading books", "knowledge", "different fields", "communication skills"]
            },
            {
                topic: "free-time",
                question: "What kinds of music/ book/ TV programs/ games do you like?",
                answer: "I like books that explain natural phenomena in life. I'm a big fan of K-pop",
                keywords: ["books", "natural phenomena", "K-pop", "fan"]
            },
            {
                topic: "free-time",
                question: "Do you prefer staying at home or going out during the evenings? Why?",
                answer: "I prefer going out. Because I like drinking coffee with my friends",
                keywords: ["prefer", "staying at home", "going out", "evenings", "drinking coffee", "friends"]
            },
            {
                topic: "free-time",
                question: "What is the importance of leisure time in life?",
                answer: "Leisure time is important for relaxation, reducing stress, and improving mental health.",
                keywords: ["leisure time", "important", "relaxation", "reducing stress", "mental health"]
            },

            // SCHOOL - TRƯỜNG HỌC
            {
                topic: "school",
                question: "Do you get along with your classmates?",
                answer: "Yes. I do, we usually hang out together.",
                keywords: ["get along", "classmates", "hang out"]
            },
            {
                topic: "school",
                question: "Why did you choose to study here?",
                answer: "I really like this school because it is beautiful and I want to be a veterinarian",
                keywords: ["why", "choose", "study", "beautiful", "veterinarian"]
            },
            {
                topic: "school",
                question: "What things do you like most when you study at your school?",
                answer: "The things I like are: I can make a lot of new friends, Friendly teachers/students, Hard-working students",
                keywords: ["like most", "new friends", "friendly teachers", "hard-working students"]
            },
            {
                topic: "school",
                question: "What things do you dislike when you study at your school?",
                answer: "I don't like: classrooms are always hot, Parking lot, Because it's small so it's difficult to take my motorbike at the rush hour.",
                keywords: ["dislike", "classrooms hot", "parking lot", "small", "difficult", "rush hour"]
            },
            {
                topic: "school",
                question: "What would you like to do in the future?",
                answer: "In the future I want to open a veterinary clinic and own it",
                keywords: ["future", "veterinary clinic", "own"]
            },
            {
                topic: "school",
                question: "What are your favorite classes/ courses/ subjects at university?",
                answer: "My favorite is veterinary medicine",
                keywords: ["favorite", "classes", "courses", "subjects", "veterinary medicine"]
            },

            // FAMILY - GIA ĐÌNH
            {
                topic: "family",
                question: "Do you have a large family or a small family?",
                answer: "I have a small family",
                keywords: ["large family", "small family"]
            },
            {
                topic: "family",
                question: "Have you got any brothers and sisters?",
                answer: "Yes. I have got two sisters",
                keywords: ["brothers", "sisters", "two"]
            },
            {
                topic: "family",
                question: "Who do you get along with your family?",
                answer: "I get along with my sister",
                keywords: ["get along", "sister"]
            },
            {
                topic: "family",
                question: "Do you spend much time with your family? Why (not)?",
                answer: "Yes I do. Because I love family so much",
                keywords: ["spend time", "family", "love"]
            },
            {
                topic: "family",
                question: "Who are you most similar to?",
                answer: "I am most similar to my father",
                keywords: ["similar", "father"]
            },
            {
                topic: "family",
                question: "What are your parents like?",
                answer: "They are friendly",
                keywords: ["parents", "friendly"]
            }
        ];

        // Tên chủ đề hiển thị
        const topicNames = {
            "greeting": "Chào hỏi",
            "hobby": "Sở thích",
            "transport": "Giao thông",
            "travel": "Du lịch",
            "free-time": "Thời gian rảnh",
            "school": "Trường học",
            "family": "Gia đình"
        };

        // Biến thống kê
        let stats = {
            totalQuestions: 0,
            viewedAnswers: 0,
            listenedQuestions: 0,
            passedTests: 0
        };

        // Biến cho Speech API
        let speechSynthesis = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;

        // Biến cho ghi âm
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimer;
        let recordingTime = 0;
        let currentQuestionIndex = null;

        // Hàm tải danh sách giọng đọc
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '<option value="">Chọn giọng đọc...</option>';
            
            // Lọc các giọng tiếng Anh
            const englishVoices = voices.filter(voice => 
                voice.lang.startsWith('en') || voice.lang.includes('US') || voice.lang.includes('UK')
            );
            
            englishVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            // Chọn giọng mặc định nếu có
            if (englishVoices.length > 0) {
                const defaultVoice = englishVoices.find(voice => 
                    voice.lang.includes('US') || voice.lang.includes('en-US')
                ) || englishVoices[0];
                
                voiceSelect.value = defaultVoice.name;
                selectedVoice = defaultVoice;
            }
        }

        // Hàm tạo câu hỏi
        function createQuestionCard(questionData, index) {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.dataset.topic = questionData.topic;
            
            card.innerHTML = `
                <div class="question">${index + 1}. ${questionData.question}</div>
                <div class="answer" id="answer-${index}">${questionData.answer}</div>
                <div class="controls">
                    <button class="show-answer-btn" data-index="${index}">
                        <span>👁</span> Xem đáp án
                    </button>
                    <button class="speak-btn" data-text="${questionData.question}">
                        <span>🔊</span> Nghe câu hỏi
                    </button>
                    <button class="record-btn" data-index="${index}">
                        <span>🎤</span> Ghi âm trả lời
                    </button>
                </div>
                <div class="recording-section" id="recording-${index}" style="display: none;">
                    <div class="recording-timer" id="timer-${index}">00:00</div>
                    <div class="recording-controls">
                        <button class="start-record-btn" data-index="${index}">
                            <span>⏺</span> Bắt đầu ghi âm
                        </button>
                        <button class="stop-record-btn" data-index="${index}" disabled>
                            <span>⏹</span> Dừng ghi âm
                        </button>
                        <button class="play-record-btn" data-index="${index}" disabled>
                            <span>▶</span> Nghe lại
                        </button>
                        <button class="evaluate-btn" data-index="${index}" disabled>
                            <span>📊</span> Đánh giá
                        </button>
                    </div>
                    <div class="audio-playback" id="playback-${index}"></div>
                    <div class="evaluation-result" id="evaluation-${index}"></div>
                </div>
            `;
            
            return card;
        }

        // Hàm hiển thị câu hỏi theo chủ đề
        function displayQuestions(topic = 'all') {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            // Lọc câu hỏi theo chủ đề
            const filteredQuestions = topic === 'all' 
                ? questionsData 
                : questionsData.filter(q => q.topic === topic);
            
            // Hiển thị tiêu đề chủ đề
            if (topic !== 'all') {
                const topicTitle = document.createElement('h2');
                topicTitle.className = 'topic-title';
                topicTitle.textContent = `${topicNames[topic]} (${filteredQuestions.length} câu hỏi)`;
                container.appendChild(topicTitle);
            } else {
                const topicTitle = document.createElement('h2');
                topicTitle.className = 'topic-title';
                topicTitle.textContent = `Tất cả chủ đề (${filteredQuestions.length} câu hỏi)`;
                container.appendChild(topicTitle);
            }
            
            // Cập nhật thống kê
            stats.totalQuestions = filteredQuestions.length;
            updateStats();
            
            // Hiển thị câu hỏi hoặc thông báo không có câu hỏi
            if (filteredQuestions.length === 0) {
                const noQuestions = document.createElement('div');
                noQuestions.className = 'no-questions';
                noQuestions.textContent = 'Không có câu hỏi nào trong chủ đề này.';
                container.appendChild(noQuestions);
            } else {
                filteredQuestions.forEach((question, index) => {
                    container.appendChild(createQuestionCard(question, index));
                });
            }
            
            // Thêm sự kiện cho các nút
            addEventListeners();
        }

        // Hàm thêm sự kiện cho các nút
        function addEventListeners() {
            // Nút hiển thị câu trả lời
            document.querySelectorAll('.show-answer-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const answerElement = document.getElementById(`answer-${index}`);
                    
                    if (answerElement.style.display === 'block') {
                        answerElement.style.display = 'none';
                        this.innerHTML = '<span>👁</span> Xem đáp án';
                    } else {
                        answerElement.style.display = 'block';
                        this.innerHTML = '<span>👁</span> Ẩn đáp án';
                        stats.viewedAnswers++;
                        updateStats();
                    }
                });
            });
            
            // Nút đọc câu hỏi
            document.querySelectorAll('.speak-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const text = this.getAttribute('data-text');
                    speakText(text, this);
                });
            });
            
            // Nút ghi âm trả lời
            document.querySelectorAll('.record-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const recordingSection = document.getElementById(`recording-${index}`);
                    
                    // Ẩn tất cả các section ghi âm khác
                    document.querySelectorAll('.recording-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Hiển thị section ghi âm hiện tại
                    recordingSection.style.display = 'block';
                    currentQuestionIndex = index;
                });
            });
            
            // Nút bắt đầu ghi âm
            document.querySelectorAll('.start-record-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    startRecording(index);
                });
            });
            
            // Nút dừng ghi âm
            document.querySelectorAll('.stop-record-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    stopRecording(index);
                });
            });
            
            // Nút nghe lại
            document.querySelectorAll('.play-record-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    playRecording(index);
                });
            });
            
            // Nút đánh giá
            document.querySelectorAll('.evaluate-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    evaluateRecording(index);
                });
            });
        }

        // Hàm bắt đầu ghi âm
        async function startRecording(index) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Lưu URL audio để sử dụng sau
                    const playbackElement = document.getElementById(`playback-${index}`);
                    playbackElement.innerHTML = `<audio controls src="${audioUrl}"></audio>`;
                    
                    // Kích hoạt nút nghe lại và đánh giá
                    document.querySelector(`.play-record-btn[data-index="${index}"]`).disabled = false;
                    document.querySelector(`.evaluate-btn[data-index="${index}"]`).disabled = false;
                    
                    // Dừng tất cả các track
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Cập nhật UI
                document.querySelector(`.start-record-btn[data-index="${index}"]`).disabled = true;
                document.querySelector(`.stop-record-btn[data-index="${index}"]`).disabled = false;
                document.querySelector(`.record-btn[data-index="${index}"]`).classList.add('recording');
                
                // Bắt đầu đếm thời gian
                recordingTime = 0;
                updateTimer(index);
                recordingTimer = setInterval(() => {
                    recordingTime++;
                    updateTimer(index);
                }, 1000);
                
            } catch (error) {
                console.error("Lỗi khi truy cập microphone:", error);
                showNotification("Không thể truy cập microphone. Vui lòng kiểm tra quyền truy cập.");
            }
        }

        // Hàm dừng ghi âm
        function stopRecording(index) {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Cập nhật UI
                document.querySelector(`.start-record-btn[data-index="${index}"]`).disabled = false;
                document.querySelector(`.stop-record-btn[data-index="${index}"]`).disabled = true;
                document.querySelector(`.record-btn[data-index="${index}"]`).classList.remove('recording');
                
                // Dừng đếm thời gian
                clearInterval(recordingTimer);
            }
        }

        // Hàm cập nhật bộ đếm thời gian
        function updateTimer(index) {
            const minutes = Math.floor(recordingTime / 60);
            const seconds = recordingTime % 60;
            const timerElement = document.getElementById(`timer-${index}`);
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Hàm phát lại bản ghi âm
        function playRecording(index) {
            const audioElement = document.querySelector(`#playback-${index} audio`);
            if (audioElement) {
                audioElement.play();
            }
        }

        // Hàm đánh giá bản ghi âm
        function evaluateRecording(index) {
            const questionData = questionsData[index];
            const evaluationElement = document.getElementById(`evaluation-${index}`);
            
            // Giả lập đánh giá dựa trên từ khóa
            // Trong thực tế, bạn sẽ cần tích hợp API nhận dạng giọng nói như Speech-to-Text
            const score = Math.floor(Math.random() * 40) + 60; // Điểm từ 60-100
            const passed = score >= 70;
            
            if (passed) {
                evaluationElement.className = 'evaluation-result pass';
                evaluationElement.innerHTML = `
                    <div>🎉 Chúc mừng! Bạn đã vượt qua bài kiểm tra</div>
                    <div>Điểm số: ${score}/100</div>
                    <div>Đánh giá: Phát âm khá tốt, cố gắng luyện tập thêm!</div>
                `;
                stats.passedTests++;
            } else {
                evaluationElement.className = 'evaluation-result fail';
                evaluationElement.innerHTML = `
                    <div>❌ Cần cải thiện</div>
                    <div>Điểm số: ${score}/100</div>
                    <div>Đánh giá: Cần luyện tập phát âm và ngữ điệu nhiều hơn</div>
                `;
            }
            
            evaluationElement.style.display = 'block';
            updateStats();
            
            // Hiển thị thông báo
            showNotification(passed ? 
                "Chúc mừng! Bạn đã hoàn thành bài kiểm tra với kết quả tốt." : 
                "Đừng nản lòng! Hãy luyện tập thêm và thử lại.", 
            passed ? "success" : "");
        }

        // Hàm đọc văn bản bằng Web Speech API
        function speakText(text, buttonElement) {
            if (!speechSynthesis) {
                showNotification("Trình duyệt của bạn không hỗ trợ chức năng đọc văn bản.");
                return;
            }
            
            // Dừng phát âm thanh hiện tại nếu có
            speechSynthesis.cancel();
            
            // Tạo utterance mới
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; // Tốc độ đọc
            utterance.pitch = 1;  // Cao độ
            
            // Chọn giọng đọc
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // Thêm hiệu ứng khi đang phát
            buttonElement.classList.add('playing');
            buttonElement.innerHTML = '<span>🔊</span> Đang phát...';
            
            // Sự kiện khi bắt đầu phát
            utterance.onstart = function() {
                buttonElement.classList.add('playing');
                buttonElement.innerHTML = '<span>🔊</span> Đang phát...';
            };
            
            // Sự kiện khi kết thúc phát
            utterance.onend = function() {
                buttonElement.classList.remove('playing');
                buttonElement.innerHTML = '<span>🔊</span> Nghe câu hỏi';
                stats.listenedQuestions++;
                updateStats();
            };
            
            // Sự kiện khi có lỗi
            utterance.onerror = function(event) {
                console.error("Lỗi phát âm thanh:", event);
                buttonElement.classList.remove('playing');
                buttonElement.innerHTML = '<span>🔊</span> Nghe câu hỏi';
                showNotification("Có lỗi xảy ra khi phát âm thanh. Vui lòng thử lại.");
            };
            
            // Phát âm thanh
            speechSynthesis.speak(utterance);
        }

        // Hàm hiển thị thông báo
        function showNotification(message, type = "") {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Hàm cập nhật thống kê
        function updateStats() {
            document.getElementById('totalQuestions').textContent = stats.totalQuestions;
            document.getElementById('viewedAnswers').textContent = stats.viewedAnswers;
            document.getElementById('listenedQuestions').textContent = stats.listenedQuestions;
            document.getElementById('passedTests').textContent = stats.passedTests;
        }

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra hỗ trợ Web Speech API
            if (!speechSynthesis) {
                showNotification("Trình duyệt của bạn không hỗ trợ chức năng đọc văn bản. Vui lòng sử dụng Chrome, Edge hoặc Safari.");
            }
            
            // Kiểm tra hỗ trợ MediaRecorder API
            if (!navigator.mediaDevices || !window.MediaRecorder) {
                showNotification("Trình duyệt của bạn không hỗ trợ chức năng ghi âm. Vui lòng sử dụng Chrome, Edge hoặc Firefox.");
            }
            
            // Tải danh sách giọng đọc
            loadVoices();
            
            // Một số trình duyệt cần thời gian để tải giọng đọc
            speechSynthesis.onvoiceschanged = loadVoices;
            
            // Xử lý thay đổi giọng đọc
            document.getElementById('voiceSelect').addEventListener('change', function() {
                const voiceName = this.value;
                selectedVoice = voices.find(voice => voice.name === voiceName) || null;
            });
            
            // Hiển thị tất cả câu hỏi ban đầu
            displayQuestions();
            
            // Xử lý sự kiện thay đổi chủ đề
            document.getElementById('topicSelect').addEventListener('change', function() {
                displayQuestions(this.value);
            });
        });
    </script>
</body>
</html>
